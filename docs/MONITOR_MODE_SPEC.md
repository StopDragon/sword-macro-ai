# 모니터링 모드 기획서

## 1. 개요

### 1.1 목적
**패시브 데이터 수집**을 통해 게임 확률/통계의 신뢰도를 높인다.

현재 데이터 수집의 한계:
- 내 계정 하나에서만 데이터 수집
- 샘플 수 부족으로 통계 신뢰도 낮음
- 특히 고레벨 강화, 역배 등 희귀 이벤트 데이터 부족

모니터링 모드의 가치:
- 단톡방 전체 유저의 데이터를 **수동 개입 없이** 수집
- N명의 유저 × M시간 = 대량 데이터
- 매크로 없이 채팅창만 켜놓으면 됨

### 1.2 설계 원칙
1. **완전 패시브**: 명령어 입력 없이 채팅만 읽음
2. **눈치 안 보임**: 다른 유저에게 티 안 남
3. **고품질 데이터**: 노이즈 필터링, 중복 제거
4. **장시간 운영**: 메모리 누수 없이 24시간+ 가동 가능

---

## 2. 수집 대상 데이터

### 2.1 강화 데이터 (최우선)
```
수집 항목:
- 강화 전 레벨 (fromLevel)
- 강화 후 레벨 (toLevel)
- 결과 (success/hold/destroy)
- 아이템 타입 (normal/special/trash) - 가능하면
- 아이템 이름 - 가능하면

가치:
- 레벨별 실측 강화 확률 계산
- 기존 확률표 vs 실측 비교
- 특수/일반 아이템 확률 차이 분석
```

**게임 메시지 예시**:
```
⚔️ [강화]
+9 → +10
강화에 성공했습니다!
⚔️획득 검: [+10] 불꽃검
💵사용 골드: -100G
💰남은 골드: 1,234,567G
```

### 2.2 배틀 데이터
```
수집 항목:
- 승자/패자 유저명
- 승자/패자 레벨
- 전리품 골드
- 역배 여부 (레벨 차이)

가치:
- 레벨차별 역배 승률 실측
- 배틀 보상 분포 분석
```

**게임 메시지 예시**:
```
⚔️ [배틀]
@철수 『[+12] 화염검』
vs
@영희 『[+8] 빙결검』
━━━━━━━━━━━━━━━━
결과: @영희 의 승리!
전리품 500G를 획득!
```

### 2.3 판매 데이터
```
수집 항목:
- 판매 아이템 레벨
- 판매 아이템 이름
- 판매 금액
- 아이템 타입

가치:
- 레벨별 판매가 분포
- 타입별 판매가 차이 분석
- 최적 판매 시점 검증
```

**게임 메시지 예시**:
```
💰 [판매]
⚔️판매 검: [+10] 불꽃검
💶획득 골드: +5,000G
💰현재 보유 골드: 1,239,567G
⚔️새로운 검 획득: [+0] 낡은 검
```

### 2.4 특수 아이템 발견
```
수집 항목:
- 아이템 이름
- 발견 컨텍스트 (강화 중? 수령?)

가치:
- 특수 아이템 출현 빈도
- 아이템별 희귀도 추정
```

---

## 3. 카카오톡 채팅 구조 분석

### 3.1 채팅 형식
카카오톡 채팅을 클립보드로 복사하면:
```
유저명A
메시지 내용
메시지 내용 (여러 줄)

유저명B
다른 메시지

게임봇
━━━━━━━━━━━━━━━━
⚔️ [강화]
+9 → +10
강화에 성공했습니다!
━━━━━━━━━━━━━━━━
```

### 3.2 게임 봇 메시지 특징
- `━━━` 구분선으로 시작/끝
- 이모지 접두사: ⚔️, 💰, 💵, 💶, 📊 등
- 대괄호 태그: `[강화]`, `[배틀]`, `[판매]`, `[프로필]`
- 특수 문자: 『』, →, +N

### 3.3 유저 메시지 vs 봇 메시지 구분
```go
// 게임 봇 메시지 감지 조건:
// 1. 구분선 포함: ━━━
// 2. 게임 태그 포함: [강화], [배틀], [판매]
// 3. 게임 이모지 포함: ⚔️, 💰
// 4. 레벨 패턴 포함: +N, [+N]
```

---

## 4. 데이터 품질 관리

### 4.1 중복 제거
```
문제: 같은 강화 결과가 여러 번 읽힐 수 있음
해결:
- 이벤트 해시 = 타입 + 레벨 + 결과 + 시간(초단위)
- 30초 이내 동일 해시는 무시
- 최대 100개 해시 캐시 (메모리 관리)
```

### 4.2 노이즈 필터링
```
무시해야 할 것:
- 일반 유저 채팅 (게임 관련 아님)
- 불완전한 메시지 (중간에 잘림)
- 오래된 메시지 (히스토리에서 다시 읽힘)

필터링 전략:
- 새로 추가된 텍스트만 파싱 (diff 기반)
- 게임 봇 메시지 패턴만 처리
- 필수 필드 검증 (레벨, 결과 등)
```

### 4.3 데이터 신뢰도 태깅
```go
type MonitorEvent struct {
    // ... 기존 필드 ...

    // 신뢰도 관련
    Confidence  float64 // 0.0 ~ 1.0
    Source      string  // "full_message", "partial", "inferred"
    Timestamp   time.Time
}

// 신뢰도 계산:
// - 전체 메시지 파싱 성공: 1.0
// - 일부 필드 누락: 0.7
// - 추론된 값 있음: 0.5
```

---

## 5. 서버 API 확장

### 5.1 모니터링 데이터 전용 엔드포인트
```
POST /api/telemetry/monitored
{
    "session_id": "uuid",
    "period": "2024-01-15",
    "monitored_events": {
        "enhance": [
            {"from": 9, "to": 10, "result": "success", "count": 5},
            {"from": 10, "to": 10, "result": "hold", "count": 3},
            {"from": 10, "to": 0, "result": "destroy", "count": 1}
        ],
        "battle": [
            {"winner_level": 8, "loser_level": 12, "gold": 500, "count": 2}
        ],
        "sale": [
            {"level": 10, "type": "normal", "gold": 5000, "count": 3}
        ],
        "special": [
            {"name": "광선검", "count": 1}
        ]
    }
}
```

### 5.2 모니터링 통계 API
```
GET /api/stats/monitored
{
    "total_monitored_events": 12345,
    "enhance_by_level": {
        "9": {"success": 234, "hold": 456, "destroy": 78, "rate": 0.289},
        "10": {"success": 123, "hold": 345, "destroy": 67, "rate": 0.230}
    },
    "battle_by_diff": {
        "4": {"total": 50, "upset_wins": 12, "upset_rate": 0.24}
    },
    "data_quality": {
        "avg_confidence": 0.87,
        "unique_sessions": 45
    }
}
```

---

## 6. UI/UX 설계

### 6.1 실행 흐름
```
메뉴 5번 선택
    ↓
"모니터링 모드를 시작합니다"
"다른 유저들의 강화/배틀/판매 데이터를 수집합니다"
"명령어를 보내지 않아 다른 유저에게 티나지 않습니다"
    ↓
실행 시간 입력 (0 = 무제한)
    ↓
좌표 설정 (채팅 영역)
    ↓
모니터링 시작
```

### 6.2 실시간 표시
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  👀 모니터링 중 (1시간 23분 경과)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 수집 현황
  ├─ 강화: 156건 (성공 45, 유지 89, 파괴 22)
  ├─ 배틀: 34건 (역배 승리 8건)
  ├─ 판매: 78건
  └─ 특수: 3건

  💡 최근 이벤트
  └─ [14:32:15] 강화 +11 → +12 성공
  └─ [14:31:52] 배틀 @철수(+8) > @영희(+12) 역배!
  └─ [14:30:44] 판매 +10 5,000G
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  F9: 종료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 6.3 종료 시 리포트
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 모니터링 세션 리포트
  실행 시간: 2시간 45분
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ⚔️ 강화 통계 (총 312건)
  ┌────────┬────────┬────────┬────────┬─────────┐
  │ 레벨   │ 성공   │ 유지   │ 파괴   │ 실측확률 │
  ├────────┼────────┼────────┼────────┼─────────┤
  │ +9→10  │ 45     │ 78     │ 12     │ 33.3%   │
  │ +10→11 │ 23     │ 56     │ 8      │ 26.4%   │
  │ +11→12 │ 12     │ 34     │ 6      │ 23.1%   │
  └────────┴────────┴────────┴────────┴─────────┘

  ⚔️ 역배 통계 (총 45건)
  ┌────────┬────────┬────────┬─────────┐
  │ 레벨차 │ 시도   │ 성공   │ 승률    │
  ├────────┼────────┼────────┼─────────┤
  │ 1-3    │ 20     │ 8      │ 40.0%   │
  │ 4-6    │ 15     │ 4      │ 26.7%   │
  │ 7+     │ 10     │ 1      │ 10.0%   │
  └────────┴────────┴────────┴─────────┘

  💰 판매 통계 (총 89건)
  평균 판매 레벨: +9.2
  평균 판매가: 3,456G

  ✨ 특수 아이템 (총 4건)
  - 광선검 x2
  - 기타검 x1
  - 우산 x1

  📤 서버 전송 완료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 7. 구현 로드맵

### Phase 1: 기본 동작 (현재 완료)
- [x] ModeMonitor 추가
- [x] loopMonitor 기본 구조
- [x] 이벤트 파싱 (강화/배틀/판매/특수)
- [x] 중복 제거 (해시 기반)
- [x] 텔레메트리 연동

### Phase 2: 품질 개선
- [ ] 게임 봇 메시지 필터링 강화
- [ ] 신뢰도 점수 시스템
- [ ] 파싱 정확도 향상 (정규식 튜닝)
- [ ] 메모리 최적화 (장시간 운영)

### Phase 3: 서버 확장
- [ ] 모니터링 전용 API 엔드포인트
- [ ] DB 스키마 확장 (monitored_ 테이블)
- [ ] 모니터링 데이터 별도 집계
- [ ] 데이터 품질 메트릭

### Phase 4: 분석 고도화
- [ ] 실측 확률 vs 기본 확률 비교
- [ ] 시간대별 확률 분석
- [ ] 아이템 타입별 확률 분석
- [ ] 대시보드 통계 페이지

---

## 8. 기술적 고려사항

### 8.1 메모리 관리
```go
// 장시간 운영 시 메모리 누수 방지
const (
    maxHashCache     = 100     // 중복 체크용 해시 최대 개수
    hashExpiry       = 30 * time.Second
    cleanupInterval  = 1 * time.Minute
)
```

### 8.2 에러 핸들링
```go
// 파싱 실패 시 조용히 무시 (모니터링이므로)
// 로그만 남기고 계속 진행
if err != nil {
    logger.Debug("파싱 실패: %v", err)
    continue
}
```

### 8.3 리소스 사용
```
- 폴링 주기: 800ms (초안) → 1000ms (안정)
- CPU: 거의 0% (대기 시간이 대부분)
- 메모리: ~10MB (해시 캐시 포함)
- 네트워크: 3분마다 텔레메트리 전송
```

---

## 9. 테스트 시나리오

### 9.1 기본 동작 테스트
1. 모니터링 시작 → 채팅에 강화 메시지 표시 → 감지 확인
2. 동일 메시지 재표시 → 중복 필터링 확인
3. 일반 채팅 → 무시 확인

### 9.2 장시간 운영 테스트
1. 1시간 연속 운영 → 메모리 사용량 확인
2. 8시간 연속 운영 → 안정성 확인
3. 텔레메트리 전송 확인 (3분마다)

### 9.3 데이터 품질 테스트
1. 정상 메시지 → 파싱 정확도 100%
2. 불완전 메시지 → graceful 처리
3. 노이즈 메시지 → 필터링

---

## 10. 향후 확장 아이디어

### 10.1 반능동 모드 (옵션)
- 가끔 `/랭킹` 조회로 추가 데이터 수집
- 프로필 조회로 유저별 데이터 보강

### 10.2 다중 채팅방 지원
- 여러 단톡방 동시 모니터링
- 채팅방별 통계 분리

### 10.3 실시간 알림
- 희귀 이벤트 발생 시 알림 (예: 14강 성공)
- 특수 아이템 발견 시 알림

### 10.4 데이터 내보내기
- CSV/JSON 형식 내보내기
- 외부 분석 도구 연동
